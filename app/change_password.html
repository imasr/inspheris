<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width">
        <title>Changez votre mot de passe</title>
        <link href="styles/theme.css" rel="stylesheet">
        <link href="styles/vendor.css" rel="stylesheet">
        <script src="scripts/scripts.js"></script>
        <script src="scripts/vendor.js"></script>
        
		<!--<link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.css" />  
		<script src="bower_components/jquery/dist/jquery.js"></script>
		<script src="bower_components/angular/angular.min.js"></script>
		<script src="bower_components/bootstrap/dist/js/bootstrap.js"></script>
        <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.css" />  -->
        
        <link rel="icon" href="favicon.ico" type="image/x-icon">
        <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
        <link type="image/x-icon" href="favicon.ico" />

        <style type="text/css">

            html { 
            }

            body { 
                background: url(../images/lively/bg.jpg) no-repeat center center fixed;  
                -webkit-background-size: cover;
                -moz-background-size: cover;
                -o-background-size: cover;
                background-size: cover;
                min-height:100%;
            }

            p
            {
                margin:10px 0;
                color: black;
            }

            html, body, .container-table {
                height: 100%;
                min-height:100%;
            }
            .container-table {
                display: table;
            }
            .vertical-center-row {
                display: table-cell;
                vertical-align: middle;
            }

            /*****loginPAGE****/

            .changePass-container.changePass {
                padding: 40px 30px;
                color: #fff;
                border-radius: 6px;
            }

            .changePass-container.changePass .btn {
                font-weight: 700;
                height: 44px;
                -moz-user-select: none;
                -webkit-user-select: none;
                -ms-user-select: none;
                user-select: none;
                cursor: pointer;
            }

            .changePass {
                background: rgba(255,255,255,0.85);
                padding: 20px 25px 30px;
                margin: 20px auto;
                border-radius: 5px;
                box-shadow: 5px 0 24px rgba(86,140,163,.15);
                -webkit-box-shadow: 5px 0 24px rgba(86,140,163,.15);
            }


            .form-changePass #inputEmail,
            .form-changePass #inputPassword {
                direction: ltr;
                height: 40px;
            }

            .form-changePass input[type=email],
            .form-changePass input[type=password],
            .form-changePass input[type=text],
            .form-changePass button {
                width: 100%;
                display: block;
                margin-bottom: 10px;
                z-index: 1;
                position: relative;
                box-sizing: border-box;
                height: 44px;
                border: 1px solid #ddd;
                box-shadow: 5px 0 24px rgba(86,140,163,.15);
                -webkit-box-shadow: 5px 0 24px rgba(86,140,163,.15);
            }

            .form-changePass .form-control:focus {
                border-color: rgb(125, 31, 91);
                outline: 0;
                padding-bottom: 10px;
                box-shadow: inset 0 1px 1px rgba(0,0,0,.075),0 0 8px rgb(104, 145, 162);
            }
            .form-changePass{
                padding-bottom: 10px;
            }

            .btn.btn-signin {
                /*background-color: rgb(125, 31, 91);*/
                padding: 0px;
                font-weight: 700;
                font-size: 14px;
                height: 36px;
                border-radius: 3px;
                border: none;
                transition: all 0.218s;
            }

            .btn.btn-signin:hover,
            .btn.btn-signin:active,
            .btn.btn-signin:focus {
                background-color: rgb(125, 175, 92);
            }
            @media (min-width: 992px){
                #changePass .col-md-6 {
                    width: 44%;
                }

                #changePass .col-md-offset-3 {
                    margin-left: 28%;
                }
            }
            }
        </style>
    </head>
    <body ng-app="inspherisProjectApp" ng-controller="ChangePasswordCtrl">
        
        <div class="container container-table"  id="changePass">
            <div class="row vertical-center-row">
                <div class="col-md-6 col-md-offset-3 col-sm-6 col-sm-offset-3 col-xs-12">
                    <div class="changePass changePass-container" ng-if="activeToken && vaidToken">
                        <div class="text-center"> <img src="images/lively/logo.png">
                            <h2 style="color: #555;">Changez votre mot de passe </h2>
                            <p> Entrez votre identifiant et votre nouveau mot de passe ci-dessous.</p>
                            <p> Une fois confirmé, vous serez connecté avec votre nouveau mot de passe.</p>
                        </div> 
                        <form class="form-changePass" name="changePasswordForm" ng-submit="submit()" ng-controller="ChangePasswordCtrl">
                            <span id="reauth-email" class="reauth-email"></span>
                            <input type="password" class="form-control" ng-model="password" name="password" placeholder="Mot de passe">
                            <input type="password" class="form-control" ng-model="confirmPassword" name="confirmPassword" placeholder="Confirmez le mot de passe"> 
                            <button class="btn btn-lg btn-danger btn-block btn-signin" type="submit" value="Submit">Soumettre
                                <span ng-if="loadingStart"><i class="fa fa-spin fa-spinner"></i></span>
                            </button>
                        </form>
                        <div class="text-center">
                            <p style="color:red;display:none;" id="note"></p>
                            <a style="color:#2C93E4;" href="/login.html">Retour pour se connecter</a>
                        </div>
                    </div>
                    
                    <div class="changePass" ng-if="!activeToken">
                        <div class="text-center">
                            <img src="images/lively/logo.png">
                            <h2 style="color: #555;" ng-if="vaidToken">Expiration du lien  </h2>
                            <h2 style="color: #555;" ng-if="!vaidToken">Le lien n’est pas valide  </h2>
                            <p> Vous devez envoyez un mail afin d’obtenir un nouveau lien.</p>
                            <div><a class="btn btn-info" style="color:#fff; margin-top: 20px;" href="/forgot_password.html">Envoyer un nouvel email</a></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
   
	<script>
            angular.module('inspherisProjectApp', [])
            .controller('ChangePasswordCtrl', ['$scope', '$http', '$window', '$location', function ($scope, $http, $window, $location) {
                    $scope.loadingStart = false;
                    function getAllUrlParams(url) {
                        var queryString = url ? url.split('?')[1] : window.location.search.slice(1);
                        var obj = {};
                        if (queryString) {
                            queryString = queryString.split('#')[0];
                            var arr = queryString.split('&');
                            for (var i = 0; i < arr.length; i++) {
                                var a = arr[i].split('=');
                                var paramNum = undefined;
                                var paramName = a[0].replace(/\[\d*\]/, function (v) {
                                    paramNum = v.slice(1, -1);
                                    return '';
                                });

                                var paramValue = typeof (a[1]) === 'undefined' ? true : a[1];
                                paramName = paramName.toLowerCase();
                                paramValue = paramValue.toLowerCase();

                                if (obj[paramName]) {
                                    if (typeof obj[paramName] === 'string') {
                                        obj[paramName] = [obj[paramName]];
                                    }

                                    if (typeof paramNum === 'undefined') {
                                        obj[paramName].push(paramValue);
                                    } else {
                                        obj[paramName][paramNum] = paramValue;
                                    }
                                } else {
                                    obj[paramName] = paramValue;
                                }
                            }
                        }
                        return obj;
                    };


                    $scope.activeToken = null;
                    $scope.vaidToken = true;
                    $scope.validatePasswordToken = function (userUid, token) {
                        $http.get('/api/user/password/validate-token', {params: {uid: userUid, token: token}}).then(function onSuccess(response) {
                            var data = response.data;
                            if (typeof (data.code) != 'undefined' && data.code != null) {
                                $scope.vaidToken = false;
                            } else {
                                $scope.activeToken = data;
                            }
                        });
                    };

                    $scope.userUid = getAllUrlParams($location.absUrl()).uid;
                    $scope.token = getAllUrlParams($location.absUrl()).token;
                    $scope.validatePasswordToken($scope.userUid, $scope.token);

                    $scope.submit = function () {
                        $scope.loadingStart = true;
                        if (typeof ($scope.password) == 'undefined' || $scope.password == '') {
                            $("#note").html("Veuillez entrer votre nouveau mot de passe, s’il vous plaît");
                            $("#note").css("display", "block");
                            $scope.loadingStart = false;
                            return null;
                        }

                        if (typeof ($scope.confirmPassword) == 'undefined' || $scope.confirmPassword == '') {
                            $("#note").html("Veuillez confirmer votre mot de passe s’il vous plaît");
                            $("#note").css("display", "block");
                            $scope.loadingStart = false;
                            return null;
                        }

                        var postdata = {
                            uid: $scope.userUid,
                            password: $scope.password,
                            confirmPassword: $scope.confirmPassword,
                            isForgotPassword: true,
                            passwordToken: $scope.token
                        };

                        $http.post('/api/user/changePassword', postdata).then(function onSuccess(response) {
                            $scope.loadingStart = false;
                            var data = response.data;
                            if (typeof (data.code) != 'undefined' && data.code != null) {
                                $("#note").html(data.message);
                                $("#note").css("display", "block");
                            } else {
                                $window.location.href = "/message_change_password.html";
                            }
                        });
                    };
                }]);	
	</script>
    </body>
</html>
